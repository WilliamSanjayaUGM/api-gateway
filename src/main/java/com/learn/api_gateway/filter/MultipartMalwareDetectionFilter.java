package com.learn.api_gateway.filter;

import java.nio.charset.StandardCharsets;
import java.util.Locale;
import java.util.regex.Pattern;

import org.springframework.cloud.gateway.filter.GatewayFilterChain;
import org.springframework.cloud.gateway.filter.GlobalFilter;
import org.springframework.core.Ordered;
import org.springframework.core.annotation.Order;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Component;
import org.springframework.web.server.ServerWebExchange;
import org.springframework.web.server.WebFilter;
import org.springframework.web.server.WebFilterChain;

import com.learn.api_gateway.util.GatewayUtil;
import com.learn.api_gateway.util.WAFBootstrapUtil;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import reactor.core.publisher.Mono;

/**
 * .exe .jsp .php .ps1 .jar .sh etc
 * Embedded <?php, <script>
 * Double-extension tricks (invoice.pdf.exe)
 */
@Component
@Slf4j
@RequiredArgsConstructor
public class MultipartMalwareDetectionFilter implements GlobalFilter, Ordered{
	private final WAFBootstrapUtil wafBootStrapUtil;
	private final GatewayUtil gatewayUtil;
	
	private static final Pattern DANGEROUS_FILENAME =
            Pattern.compile("filename=\".*\\.(exe|dll|php|jsp|jspx|sh|bat|ps1|jar|war|ear)(\\.|\"|$)",
                    Pattern.CASE_INSENSITIVE);
	
	private static final int MAX_SCAN_BYTES = 64 * 1024;
	
	@Override
	public int getOrder() {
		return -770;
	}
	
	@Override
	public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
		MediaType ct = exchange.getRequest().getHeaders().getContentType();
        if (ct == null || !MediaType.MULTIPART_FORM_DATA.isCompatibleWith(ct)) {
        	log.info("-------MultipartMalwareDetectionFilter is ct {}-------", ct);
            return chain.filter(exchange);
        }
        
        log.info("-------MultipartMalwareDetectionFilter is running-------");
        byte[] body = gatewayUtil.getCachedRequestBody(exchange);
        if (body == null || body.length == 0) {
            return chain.filter(exchange);
        }

        int scanLength = Math.min(body.length, MAX_SCAN_BYTES);
        String snippet = new String(body, 0, scanLength, StandardCharsets.ISO_8859_1)
                .toLowerCase(Locale.ROOT);

        if (isMaliciousMultipart(snippet)) {
            return wafBootStrapUtil.block(
                exchange,
                HttpStatus.BAD_REQUEST,
                "Multipart malware blocked"
            );
        }

        return chain.filter(exchange);
	}
	
	private boolean isMaliciousMultipart(String snippet) {

        // Dangerous executable filenames
        if (DANGEROUS_FILENAME.matcher(snippet).find()) {
            return true;
        }

        // Obvious embedded scripts (signal-level, but acceptable at gateway)
        if (snippet.contains("<?php") ||
            snippet.contains("<script")) {
            return true;
        }

        return false;
    }
}
